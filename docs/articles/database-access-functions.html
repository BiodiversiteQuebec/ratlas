<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Functions to directly access the database ressources • ratlas</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Functions to directly access the database ressources">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ratlas</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/database-access-functions.html">Functions to directly access the database ressources</a></li>
    <li><a class="dropdown-item" href="../articles/download-obs.html">Download observations from Atlas</a></li>
    <li><a class="dropdown-item" href="../articles/download-regions-observations.html">Download observations by region from Atlas</a></li>
    <li><a class="dropdown-item" href="../articles/post-dataset.html">Write and insert dataset metadata to Atlas</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Functions to directly access the database ressources</h1>
            
      

      <div class="d-none name"><code>database-access-functions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>ratlas</code> package provides functions to interact with
Biodiversité Québec’s database <code>Atlas</code>. For most use cases,
<code>ratlas</code> get functions such as <code>get_taxa</code>,
<code>get_observations</code>, <code>get_datasets</code>, etc should be
used, as they are designed to be more user-friendly. However, in some
cases, it is useful to directly access the database ressources.</p>
<p>This vignette describes how to do so using low-level functions
<code>db_read_table</code> and <code>db_call_function</code>, on which
<code>ratlas</code> get functions are based and is intended for advanced
users.</p>
</div>
<div class="section level2">
<h2 id="atlas-database">Atlas database<a class="anchor" aria-label="anchor" href="#atlas-database"></a>
</h2>
<p>Atlas database is a PostgreSQL database. It contains several tables,
views, materialized views, functions, etc. Data is stored and made
available through those resources. While table store data, views and
materialized views behaves as tables and are used to store queries, and
functions are used to perform operations on the data. They are organized
by different schema, each of them representing a different application
layer of the database. The following schemas are available:</p>
<ul>
<li>
<code>public</code>: Raw biodiversity data is stored here in tables
such as <code>observations</code>, <code>taxa_obs</code>,
<code>datasets</code>, <code>variables</code>, <code>efforts</code>,
etc. This schema is relational, as joins between tables are required to
retrieve data. Data may be protected by access rights and require
authentication to be accessed through a token (see README).</li>
<li>
<code>api</code>: This schema contains views and functions that are
used to access data from the <code>public</code> schema. It performs
joins between tables, and returns data in a more user-friendly format.
This schema is used by the <code>ratlas</code> read/call functions. Data
may be protected by access rights and require authentication to be
accessed through a token (see README).</li>
<li>
<code>atlas-api</code>: This schema contains tables, views and
functions required for the operation of the <a href="https://biodiversite-quebec.ca/en/atlas" class="external-link">‘atlas web portal’</a>.
All displayed information and summary statistics are computed from
resources in this schema. Data at this layer is not protected by access
rights and can be accessed without authentication.</li>
</ul>
<p>Documentation for tables and functions are made availabe in atlas-db
repository documentation.</p>
</div>
<div class="section level2">
<h2 id="reading-tables-and-views-data">Reading tables and views data<a class="anchor" aria-label="anchor" href="#reading-tables-and-views-data"></a>
</h2>
<p>The db_read_table() function is used to read data from a PostgreSQL
table. It takes several arguments, including the name of the table, the
schema that the table belongs to, and the authentication token that is
required to access the database.</p>
<p>Here’s an example of how to use the db_read_table() function to read
data from a table named “taxa_obs” in the “public” schema:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">ratlas</span><span class="op">)</span></span>
<span><span class="co"># Added a limit of 100 to simplify the process</span></span>
<span><span class="co"># Remove the limit argument if you want the whole table</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, limit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p>The db_read_table() function returns a data.frame object containing
the data from the table. The data.frame columns are named after the
table columns. The data.frame row names are the row numbers of the
table.</p>
<div class="section level3">
<h3 id="filtering-data-using-column-values">Filtering data using column values<a class="anchor" aria-label="anchor" href="#filtering-data-using-column-values"></a>
</h3>
<p>The db_read_table() function also allows you to filter the data that
is returned by specifying additional arguments. For example, you can use
the <code>...</code> argument to specify a filter condition:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, id <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, scientific_name <span class="op">=</span> <span class="st">'Acer saccharum'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Using a list of values</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, scientific_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'Acer saccharum'</span>, <span class="st">'Acer rubrum'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="selecting-columns-and-limit-the-number-of-rows">Selecting columns and limit the number of rows<a class="anchor" aria-label="anchor" href="#selecting-columns-and-limit-the-number-of-rows"></a>
</h3>
<p>The limit and select arguments can be used to limit the number of
rows returned by the function and to select specific columns from the
table.</p>
<p>Those arguments are useful when working with large tables, as they
allow you to limit the amount of data that is returned by the
function.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, limit <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, select <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"scientific_name"</span><span class="op">)</span>, limit <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="returning-geometries">Returning geometries<a class="anchor" aria-label="anchor" href="#returning-geometries"></a>
</h3>
<p>Many tables in the database contain geometries. For example, the
<code>observations</code> table contains a <code>geom</code> column that
contains the location of the observation. By default, the
db_read_table() function returns a data.frame object with the geometry
column as a list of points. However, you can use the
<code>output_geometry</code> argument to return the data as a
<code>sf</code> object, made available by the <code>sf</code> package.
The <code>sf</code> object is our preferred format for working with
geometries in R.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regions</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"regions"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, output_geometry <span class="op">=</span> <span class="cn">TRUE</span>, type <span class="op">=</span> <span class="st">'admin'</span>, scale <span class="op">=</span> <span class="st">'2'</span><span class="op">)</span> <span class="co"># Administrative regions of Quebec</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"observations"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, output_geometry <span class="op">=</span> <span class="cn">TRUE</span>, within_quebec <span class="op">=</span> <span class="cn">TRUE</span>, limit <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the regions and the observations</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">regions</span><span class="op">$</span><span class="va">geom</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">geom</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="paginating-results">Paginating results<a class="anchor" aria-label="anchor" href="#paginating-results"></a>
</h3>
<p>By default, the function paginates the results using a number of
500,000 rows per page, as prescribed by <code>.page_limit</code> default
value. If the table contains more, the function will automatically
download the results in multiple pages and concatenate them into a
single data frame.</p>
<p>You can customize the pagination behavior by specifying the limit and
offset parameters in the query. The db_read_table() function also
provides additional parameters to control the pagination process, such
as .n_pages and .page_limit.</p>
<p>Here’s an example of how to use the get_table_data() function to
download the 100 rows of a table, starting at row 200:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, limit <span class="op">=</span> <span class="fl">100</span>, offset <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p>In this example, the results are paginated into multiple pages of 100
rows each.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"taxa_obs"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, .page_limit <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parallelization-of-requests">Parallelization of Requests<a class="anchor" aria-label="anchor" href="#parallelization-of-requests"></a>
</h3>
<p>To handle downloading data with very large number of rows, the
function makes requests in parallel using multiple cores. The
db_read_table() function provides an optional parameter,
<code>.cores</code>, to specify the number of cores to use for parallel
processing.</p>
<p>By default, the function downloads the results using parallelization
using 4 cores, as defined by default value of <code>.cores</code>. The
function will automatically determine the number of pages to download
and split the work across the specified number of cores. The results are
then combined into a single data frame.</p>
<p>Here’s an example of how to use the db_read_table() function to
download four pages of data in parallel using 4 cores:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_read_table.html">db_read_table</a></span><span class="op">(</span><span class="st">"observations"</span>, schema <span class="op">=</span> <span class="st">"public"</span>, .n_pages <span class="op">=</span> <span class="fl">4</span>, .cores <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="reading-functions-data">Reading functions data<a class="anchor" aria-label="anchor" href="#reading-functions-data"></a>
</h2>
<p>The db_call_function() function is used to read data from a
PostgreSQL function. It takes several arguments, including the name of
the function, the schema that the function belongs to, and the
authentication token that is required to access the database. Functions
arguments can be passed to the function using the <code>...</code>
argument.</p>
<p>Accepted arguments are described in the function documentation. For
example, the <code>atlas_api.obs_summary</code> function takes the
following optionnal arguments (<code>taxa_keys</code>,
<code>min_year</code>, <code>max_year</code>, <code>region_fid</code>,
<code>region_type</code>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_call_function.html">db_call_function</a></span><span class="op">(</span><span class="st">"obs_summary"</span>, schema <span class="op">=</span> <span class="st">"atlas_api"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/db_call_function.html">db_call_function</a></span><span class="op">(</span><span class="st">"obs_summary"</span>, schema <span class="op">=</span> <span class="st">"atlas_api"</span>, taxa_keys <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, min_year <span class="op">=</span> <span class="fl">2010</span>, max_year <span class="op">=</span> <span class="fl">2015</span>, region_fid <span class="op">=</span> <span class="fl">1</span>, region_type <span class="op">=</span> <span class="st">'admin'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Vincent Beauregard, Benjamin Mercier.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
